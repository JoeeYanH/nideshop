# NideShop 系统架构文档

## 概要

NideShop 是一个基于 Node.js + ThinkJS + MySQL 的电商平台后端系统，主要为微信小程序提供 API 服务。整个系统采用前后端分离架构，包含以下核心子系统：

### 系统架构概览
```
┌─────────────────────────────────────────────────────────────┐
│                    NideShop 电商平台                         │
├─────────────────────┬───────────────────┬─────────────────────┤
│   微信小程序客户端   │    后台管理系统    │     第三方集成       │
│                    │                   │                    │
│  - 商品浏览         │  - 商品管理        │  - 微信支付          │
│  - 购物车           │  - 订单管理        │  - 快递查询          │
│  - 订单管理         │  - 用户管理        │  - 微信登录          │
│  - 用户中心         │  - 分类管理        │                    │
└─────────────────────┴───────────────────┴─────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │   ThinkJS 服务层   │
                    │                   │
                    │  API 子系统  │ Admin 子系统
                    └─────────┬─────────┘
                              │
                    ┌─────────┴─────────┐
                    │    MySQL 数据库    │
                    └───────────────────┘
```

### 核心业务流程

1. **用户认证流程**：微信登录 → Token 生成 → 权限验证
2. **商品展示流程**：分类查询 → 商品列表 → 商品详情 → 规格选择
3. **购物流程**：添加购物车 → 地址选择 → 订单提交 → 支付处理
4. **订单管理流程**：订单查询 → 状态更新 → 物流跟踪
5. **后台管理流程**：管理员登录 → 数据管理 → 系统维护

### 子系统关系

- **API 子系统**：为前端小程序提供 RESTful API 服务
- **Admin 子系统**：为后台管理人员提供管理接口
- **Common 子系统**：提供通用配置、数据库连接、中间件等基础设施
- **第三方集成**：微信支付、快递查询、微信登录等外部服务集成

## 子系统1：API 前台服务子系统

### 架构设计

API 子系统采用经典的 MVC 分层架构，专门为微信小程序和其他前端应用提供 RESTful API 服务。

```
┌─────────────────────────────────────────────────────────┐
│                API 子系统架构                            │
├─────────────────────────────────────────────────────────┤
│  Controller 层 (控制器)                                  │
│  ├─ auth.js       用户认证                               │
│  ├─ goods.js      商品相关                               │
│  ├─ cart.js       购物车                                 │
│  ├─ order.js      订单管理                               │
│  ├─ user.js       用户中心                               │
│  ├─ catalog.js    商品分类                               │
│  └─ pay.js        支付处理                               │
├─────────────────────────────────────────────────────────┤
│  Logic 层 (业务逻辑)                                     │
│  ├─ 参数验证                                             │
│  ├─ 权限检查                                             │
│  └─ 业务规则验证                                         │
├─────────────────────────────────────────────────────────┤
│  Service 层 (服务)                                      │
│  ├─ token.js      Token 管理                            │
│  ├─ weixin.js     微信集成                              │
│  └─ express.js    快递查询                              │
├─────────────────────────────────────────────────────────┤
│  Model 层 (数据模型)                                     │
│  ├─ user.js       用户数据                               │
│  ├─ goods.js      商品数据                               │
│  ├─ order.js      订单数据                               │
│  ├─ cart.js       购物车数据                             │
│  └─ region.js     地区数据                               │
└─────────────────────────────────────────────────────────┘
```

### 核心模块

#### 1. 用户认证模块 (auth.js)
- **功能**：微信登录、Token 生成与验证
- **关键方法**：
  - `loginByWeixinAction()`: 微信登录处理
  - `logoutAction()`: 用户退出
- **业务流程**：
  1. 接收微信登录 code 和用户信息
  2. 调用微信 API 验证用户身份
  3. 检查用户是否已注册，未注册则自动创建
  4. 生成 JWT Token 返回给客户端

#### 2. 商品管理模块 (goods.js)
- **功能**：商品展示、分类、搜索、详情
- **关键方法**：
  - `listAction()`: 商品列表查询
  - `detailAction()`: 商品详情
  - `categoryAction()`: 分类商品
  - `skuAction()`: 规格信息
- **特性**：支持分页、筛选、排序

#### 3. 购物车模块 (cart.js)
- **功能**：购物车商品管理
- **关键方法**：
  - `addAction()`: 添加商品
  - `updateAction()`: 更新数量
  - `checkedAction()`: 选中状态
  - `deleteAction()`: 删除商品
- **数据结构**：商品ID、规格、数量、价格

#### 4. 订单管理模块 (order.js)
- **功能**：订单提交、查询、状态管理
- **关键方法**：
  - `submitAction()`: 提交订单
  - `listAction()`: 订单列表
  - `detailAction()`: 订单详情
  - `expressAction()`: 物流查询
- **状态管理**：待付款、已付款、配送中、已完成、已取消

#### 5. 支付模块 (pay.js)
- **功能**：微信支付集成
- **关键方法**：
  - 支付参数生成
  - 支付结果通知处理
  - 订单状态更新

### 权限控制

通过 `base.js` 基类实现统一的权限验证：
- 公开接口：商品浏览、分类查询等
- 需登录接口：购物车、订单、用户中心等
- Token 验证机制：JWT + 自定义密钥

### API 接口规范

- 统一的响应格式：`{errno: 0, errmsg: 'success', data: {}}`
- RESTful 风格的 URL 设计
- 统一的错误码和错误信息
- 支持 CORS 跨域访问

## 子系统2：Admin 后台管理子系统

### 架构设计

Admin 子系统为管理员提供商品、订单、用户等数据的管理功能，采用与 API 子系统相同的分层架构。

```
┌─────────────────────────────────────────────────────────┐
│               Admin 子系统架构                           │
├─────────────────────────────────────────────────────────┤
│  Controller 层                                          │
│  ├─ auth.js       管理员认证                             │
│  ├─ goods.js      商品管理                               │
│  ├─ order.js      订单管理                               │
│  ├─ user.js       用户管理                               │
│  ├─ category.js   分类管理                               │
│  ├─ brand.js      品牌管理                               │
│  ├─ topic.js      专题管理                               │
│  └─ upload.js     文件上传                               │
├─────────────────────────────────────────────────────────┤
│  Logic 层                                               │
│  ├─ 管理员权限验证                                       │
│  ├─ 数据完整性检查                                       │
│  └─ 业务规则验证                                         │
├─────────────────────────────────────────────────────────┤
│  Service 层                                             │
│  ├─ token.js      管理员 Token                          │
│  └─ upload.js     文件处理                              │
├─────────────────────────────────────────────────────────┤
│  Model 层                                               │
│  ├─ 复用 API 子系统的数据模型                            │
│  └─ 扩展管理功能的数据操作                               │
└─────────────────────────────────────────────────────────┘
```

### 核心功能模块

#### 1. 商品管理 (goods.js)
- 商品增删改查
- 商品规格管理
- 库存管理
- 商品分类设置

#### 2. 订单管理 (order.js)
- 订单查询和筛选
- 订单状态修改
- 发货处理
- 退款处理

#### 3. 用户管理 (user.js)
- 用户信息查询
- 用户状态管理
- 用户行为分析

#### 4. 分类管理 (category.js)
- 商品分类树形结构管理
- 分类图标和描述设置
- 分类排序

#### 5. 品牌管理 (brand.js)
- 品牌信息管理
- 品牌商品关联

### 权限控制

- 基于 Token 的管理员认证
- 所有接口都需要管理员权限验证
- 统一的权限检查中间件

## 子系统3：Common 通用基础子系统

### 架构设计

Common 子系统提供项目的基础设施和通用配置，是整个应用的基础支撑。

```
┌─────────────────────────────────────────────────────────┐
│              Common 子系统架构                           │
├─────────────────────────────────────────────────────────┤
│  Configuration 配置管理                                  │
│  ├─ config.js     全局配置                               │
│  ├─ database.js   数据库配置                             │
│  ├─ middleware.js 中间件配置                             │
│  └─ router.js     路由配置                               │
├─────────────────────────────────────────────────────────┤
│  Bootstrap 启动管理                                      │
│  ├─ 应用初始化                                           │
│  ├─ 中间件加载                                           │
│  └─ 服务启动                                             │
├─────────────────────────────────────────────────────────┤
│  Middleware 中间件                                       │
│  ├─ CORS 跨域处理                                        │
│  ├─ 请求日志                                             │
│  ├─ 错误处理                                             │
│  └─ 静态资源                                             │
└─────────────────────────────────────────────────────────┘
```

### 核心配置

#### 1. 数据库配置
- MySQL 连接配置
- 连接池管理
- 表前缀设置
- 字符编码配置

#### 2. 微信配置
- 小程序 AppID 和密钥
- 微信支付配置
- 异步通知 URL

#### 3. 第三方服务配置
- 快递查询接口配置
- 文件上传配置
- 邮件服务配置

#### 4. 中间件配置
- CORS 跨域支持
- 请求响应时间记录
- 错误追踪和日志
- 静态资源服务
- 请求体解析
- 路由处理

### 启动流程

1. 加载全局配置
2. 初始化数据库连接
3. 注册中间件
4. 启动 HTTP 服务
5. 监听端口

## 数据库设计

### 核心数据表

1. **用户相关**
   - `nideshop_user`: 用户基本信息
   - `nideshop_address`: 收货地址

2. **商品相关**
   - `nideshop_goods`: 商品基本信息
   - `nideshop_goods_specification`: 商品规格
   - `nideshop_category`: 商品分类
   - `nideshop_brand`: 品牌信息

3. **订单相关**
   - `nideshop_order`: 订单主表
   - `nideshop_order_goods`: 订单商品明细
   - `nideshop_cart`: 购物车

4. **系统相关**
   - `nideshop_admin`: 管理员账户
   - `nideshop_region`: 地区信息

## 技术栈

- **后端框架**: ThinkJS 3.x
- **数据库**: MySQL 5.7+
- **身份验证**: JWT (jsonwebtoken)
- **第三方集成**: 
  - 微信小程序 SDK
  - 微信支付 SDK
  - 快递鸟物流查询
- **工具库**: 
  - lodash (工具函数)
  - moment (时间处理)
  - md5 (密码加密)
  - xml2js (XML 解析)

## 部署架构

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Nginx     │────│  Node.js    │────│   MySQL     │
│  (反向代理)  │    │ (ThinkJS)   │    │  (数据库)   │
│  (静态资源)  │    │             │    │             │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       │                   │                   │
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  微信小程序  │    │    PM2      │    │  第三方服务  │
│   (客户端)   │    │ (进程管理)   │    │ (微信/快递) │
└─────────────┘    └─────────────┘    └─────────────┘
```

## 安全策略

1. **数据验证**: Logic 层统一参数验证
2. **SQL 注入防护**: ThinkJS ORM 自动转义
3. **跨域控制**: CORS 中间件配置
4. **身份认证**: JWT Token 机制
5. **敏感信息**: 配置文件分离，环境变量管理
6. **错误处理**: 统一错误处理，避免敏感信息泄露

## 性能优化

1. **数据库优化**: 索引优化、查询优化
2. **缓存策略**: 商品信息缓存、用户 Session 缓存
3. **静态资源**: Nginx 静态文件服务
4. **负载均衡**: PM2 集群模式
5. **数据库连接池**: 连接复用，减少连接开销

---

*此架构文档描述了 NideShop 项目的整体设计和各子系统的详细架构，为开发维护提供参考。*
